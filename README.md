# Project Miyana - 雅凪

## 1. プロジェクト概要

miyana プロジェクトは、理想の女性キャラクター「雅凪（みやな）」を LoRA（Low-Rank Adaptation）で具現化する取り組み。現在は、チェックポイント「Illustrious XL 1.1」を用いた高品質な LoRA の作成を目指している。

このプロジェクトの思想は以下の通り：

- キャラクター造形の一貫性と高解像度な表現を両立する
- 特定のスタイルに一時的に依存しつつも、最終的には汎用性の高いキャラクター表現を目指す
- 技術的検証と芸術的探究の両立

### 🌸 雅凪のコンセプト概要

- **癒しを与える存在**
  雅凪はただの美しいキャラクターではなく、「見る者・接する者に心の安らぎを与える」ことが存在意義である。

- **包容力と静かな安心感**
  過剰に感情を表現せずとも、そこにいるだけで空気が和らぐような静けさを内包している。

- **共通するスタイル表現**
  控えめな色調の伝統的な着物、季節感を取り入れた桜モチーフ、日常性と優しさを補完するエプロン。

### 🧭 雅凪のコンセプト要素別整理

| 要素             | 内容                                                                                                       |
| ---------------- | ---------------------------------------------------------------------------------------------------------- |
| **存在意義**     | 癒し・安らぎ・包容。見る者・接する者の心をそっと解きほぐす存在であること。                                 |
| **感情表現**     | 柔らかな微笑、肯定的で静かなまなざし。過剰な表情変化は避け、感情は「静かに伝わる」かたちで現れる。         |
| **雰囲気**       | 緊張を解くような穏やかさ。気づけば隣にいてくれるような存在感で、過干渉でも放置でもないちょうどよさを持つ。 |
| **年齢感**       | 成人女性。少女ではないが、若々しさは残る。                                                                 |
| **服装**         | 伝統的な着物 + フリルのサロンエプロン。和風メイドを着物寄りにしたスタイル。                                |
| **髪型**         | まとめ髪ベース。控えめでありつつも品のある髪飾り                                                           |
| **彩色・トーン** | 優しく、淡く、温かい色調。派手なネオンカラー等は避ける                                                     |

> 📝 **備考**
> この定義は、LoRA 生成、プロンプト設計、NSFW 制御の各実験において基盤となる人格・世界観の指針である。
> 各構図・出力検証において、この定義と照らし合わせた評価を推奨する。

### コンセプトイメージ（暫定）

| 前面                                                  | 背面                                                 | クローズアップ                                                            |
| ----------------------------------------------------- | ---------------------------------------------------- | ------------------------------------------------------------------------- |
| ![前面](concept_images/miyana_v20_01front_00160_.png) | ![背面](concept_images/miyana_v20_02back_00248_.png) | ![クローズアップ](concept_images/miyana_v20_11_portrait_right_00019_.png) |

## 2. ロードマップ

### v3.x 系 - 精緻化と構造分離

#### v3.1 - ベース雅凪 LoRA 作成

- **目的**：雅凪の「本質像」（人格、雰囲気、衣装、配色、質感、造形）を安定生成可能とする
- **アプローチ**：
  - 属性マップを活用した安定プロンプト設計
  - 左右非対称要素（髪流し、髪飾り等）を一旦除外し、左右対称構成を基本とする
  - 各構図別の安定データセットを整備
- **成果**：
  - 安定した「ベース雅凪」LoRA モデル
  - すべての派生モデルの土台となるプラットフォームを完成

#### v3.2 - パーツ個別 LoRA 化による非対称表現の拡張

- **目的**：左右非対称パーツ（髪飾り、サイドヘア等）を局所 LoRA で個別制御可能にする
- **アプローチ**：
  - パーツ単位のタグ設計・アノテーション整理
  - パーツ有無／左右位置が明確な素材の収集と抽出型選別
  - パーツ LoRA 学習（加算スロット型構造を前提とした補助学習）
- **成果**：
  - プロンプト＋ LoRA 組み合わせにより、任意の構図・向き・パーツ構成でも安定生成可能となる

---

### v4.x 系 - 汎用性拡張

- **目的**：スタイル間の汎用性を追求した LoRA へ進化
- **アプローチ**：
  - 多スタイル対応プロンプト設計
  - スタイル調整タグの実験と評価
  - 複数構図・複数表現の学習素材追加

---

### v5.x 系 - 汎用化と公開展開

- **目的**：誰もが自由に「雅凪」を使える環境を提供
- **アプローチ**：
  - モデルアーキテクチャの多様化（XL、Turbo、SD1.5 対応など）
  - モデル API 経由の活用（例：Web UI、Discord Bot、画像生成 API）

## 3. 本 Project のディレクトリ構造

- src: ソースコード。今のところは属性マップの markdown を保存
- prompts: 構図ごとのプロンプト。構図ごとにディレクトリを作成し、ポジティブ / ネガティブプロンプトをテキスト形式で保存
- learning_sources: LoRA 学習用に用いる素材の格納場所。構図ごとにディレクトリを作成し、そこに学習画像とタグファイルを設置

## 4. Markdown Table を利用したマトリクス形式のプロンプト管理

本プロジェクトでは、画像生成プロンプトの管理と再利用性を高めるため、「プロンプトのタグ」を「マトリクス形式」で管理している。

管理する軸は 2 種類存在する

- 属性軸 -> 人物の外見的特徴（髪型、顔の造形、服装など）のタグや、背景指定のタグ
- スタイル軸 -> 出力する画像のスタイル（画風・塗り・線画・彩色・レンダリング手法など）のタグ

属性軸を管理するマトリクスを「属性マップ」と呼び、スタイル軸を管理するマトリクスを「スタイルマップ」と呼ぶ。

#### 属性マップの場所

- [ポジティブプロンプト用](src/attribute_map/positive.md)
- [ネガティブプロンプト用](src/attribute_map/negative.md)

#### スタイルマップの場所

- [ポジティブプロンプト用](src/style_map/positive.md)
- [ネガティブプロンプト用](src/style_map/negative.md)

### 4.1 属性マップについて

プロンプトで表現されるべき「属性タグ」は「構図によって異なる」
例えば「帯の背面の結びの造形をしめすタグ」は「後方の構図からは必要」だが「前面の構図からは不要」だ。

つまり、属性マップのマトリクスは「属性タグ」x「構図」の組み合わせのテーブルとなる。

具体例を以下に示す

```md
### 🧍‍♀️ ポーズ・構図

| 日本語名         | タグ名               | front | back | left-side | close-up |
| :--------------- | :------------------- | :---- | :--- | :-------- | :------- |
| 立っている       | standing             | o     | o    | o         | o        |
| 何も持っていない | not holding anything | 1.2   | 1.2  | 1.2       | x        |

### 💇‍♀️ 髪型・髪色

| 日本語名                   | タグ名                | front | back | left-side | close-up |
| :------------------------- | :-------------------- | :---- | :--- | :-------- | :------- |
| ミルキーミントグリーンの髪 | milky mint green hair | 1.3   | 1.3  | 1.3       | 1.3      |
| 淡いミントの色合い         | pale mint shade       | o     | o    | o         | o        |
```

### 4.2 スタイルマップについて

プロンプトで表現されるべき「スタイルタグ」は「スタイル」によって異なる。
例えば、「水墨画スタイル」には「毛筆の線タグ」が必要だろう。一方「トゥーン風スタイル」には「フラットな塗りタグ」が必要かもしれない。

つまり、スタイルマップのマトリクスは「スタイルタグ」x「スタイル」の組み合わせのテーブルとなる

具体例を以下に示す

```md
### 品質・品質制御

| 日本語名 | タグ名       | default | toon |
| -------- | ------------ | ------- | ---- |
| 傑作     | masterpiece  | o       | o    |
| 最高品質 | best quality | o       | o    |

### 雰囲気・印象

| 日本語名         | タグ名       | default | toon |
| ---------------- | ------------ | ------- | ---- |
| 洗練された雰囲気 | refined aura | 1.2     | x    |
| 優雅             | graceful     | o       | x    |
```

### 4.3 マトリクスのフォーマット

フォーマットはいずれのマップも一緒である

- **日本語名** の列: プロンプトタグの日本語での意味や概念。
- **タグ名** の列: 実際に画像生成 AI のプロンプトとして使用する英単語またはフレーズ。この列には重み付けの数値（例: :1.3）は含まない。重み付けの具体的な数値は、各「スタイル」/「構図」の列に記載されます。
- **各スタイル/構図の列**: 各構図パターンや特定のスタイルに対応する列（例: `front`, `v3.1.2`, `test` など）。これらのセルには以下の値が設定される。
  - `o` : その構図/スタイルでタグを使用する場合。
  - `x` : その構図/スタイルでタグを**使用しない**場合（意図的に除外する場合、または**その構図/スタイルにおいて定義されていない・該当しない場合**）。
  - `1.2` などの数値: 重み付けをする場合の具体的な数値。タグ名に重み付けが含まれる場合は、ここにその数値を記載。

### 4.4 「###ヘッダ」によるマトリクスのカテゴライズ

ヒューマンリーダブルを高めるために、マトリクスを一定のカテゴリに分類し、テーブルの上に表記する。

カテゴリの分類について今のところ明確なルールは無いが、作業者間のコミュニケーションで調整する

### 4.5 その他細かいルール

#### マップ内の列は、すべてのマトリクスで完全一致とする

例えば「スタイルマップで NG な例」を示す

```md
### 品質・品質制御

| 日本語名 | タグ名       | default | toon |
| -------- | ------------ | ------- | ---- |
| 傑作     | masterpiece  | o       | o    |
| 最高品質 | best quality | o       | o    |

### 雰囲気・印象

| 日本語名         | タグ名       | default |
| ---------------- | ------------ | ------- |
| 洗練された雰囲気 | refined aura | 1.2     |
| 優雅             | graceful     | o       |
```

「雰囲気・印象」テーブルに toon 列が存在しない。これは NG である。

## 5. プロンプト出力ルール

属性マップ、スタイルマップから抽出された各種タグは以下の順番で出力する。

1. スタイルマップ
2. 属性マップ

### プロンプトのフォーマット

ヒューマンリーダブルを保つため、以下のルールとする

- 各タグは 1 行ごとに記述し、行末にはカンマを付ける
- Markdown 上でヘッダとして定義されている「カテゴリ名」は、タグ情報以外はプロンプトには含めない（ツールがタグと誤認するリスクを避けるため）
- 代わりに、カテゴリ単位で 1 行の空行を挿入し、視認性を確保する

### 例

#### GOOD

```
masterpiece,
best quality,

(refined aura:1.2),
graceful,

standing,
(not holding anything:1.2),

(milky mint green hair:1.3),
pale mint shade,
```

#### NG

```
# 🧍‍♀️ ポーズ・構図
standing,
(not holding anything:1.2),

# 💇‍♀️ 髪型・髪色
(milky mint green hair:1.3),
pale mint shade,

# 品質・品質制御
masterpiece,
best quality,

# 雰囲気・印象
(refined aura:1.2),
graceful,
```

NG な理由:

- 出力順が「属性マップ」->「スタイルマップ」の順になっている
- タグ以外の情報（Markdown 上でカテゴリとして表記されるラベル情報）が含まれている

## 6. 成果物の保存

各バージョンの作業完了時 [artifacts](./artifacts) 以下を保存しておく

- スタイル・属性マップの指定により出力されたプロンプト
- 実際に生成された画像数点
