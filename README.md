# Project Miyana - 雅凪

## 1. プロジェクト概要

miyana プロジェクトは、理想の女性キャラクター「雅凪（みやな）」を LoRA（Low-Rank Adaptation）で具現化する取り組み。現在は、チェックポイント「Illustrious XL 1.1」を用いた高品質な LoRA の作成を目指している。

このプロジェクトの思想は以下の通り：

- キャラクター造形の一貫性と高解像度な表現を両立する
- 特定のスタイルに一時的に依存しつつも、最終的には汎用性の高いキャラクター表現を目指す
- 技術的検証と芸術的探究の両立

### 🌸 雅凪のコンセプト概要

- **癒しを与える存在**
  雅凪はただの美しいキャラクターではなく、「見る者・接する者に心の安らぎを与える」ことが存在意義である。

- **包容力と静かな安心感**
  過剰に感情を表現せずとも、そこにいるだけで空気が和らぐような静けさを内包している。

- **共通するスタイル表現**
  控えめな色調の伝統的な着物、季節感を取り入れた桜モチーフ、日常性と優しさを補完するエプロン。

### 🧭 雅凪のコンセプト要素別整理

| 要素             | 内容                                                                                                       |
| ---------------- | ---------------------------------------------------------------------------------------------------------- |
| **存在意義**     | 癒し・安らぎ・包容。見る者・接する者の心をそっと解きほぐす存在であること。                                 |
| **感情表現**     | 柔らかな微笑、肯定的で静かなまなざし。過剰な表情変化は避け、感情は「静かに伝わる」かたちで現れる。         |
| **雰囲気**       | 緊張を解くような穏やかさ。気づけば隣にいてくれるような存在感で、過干渉でも放置でもないちょうどよさを持つ。 |
| **年齢感**       | 成人女性。少女ではないが、若々しさは残る。                                                                 |
| **服装**         | 伝統的な着物 + フリルのサロンエプロン。和風メイドを着物寄りにしたスタイル。                                |
| **髪型**         | まとめ髪ベース。控えめでありつつも品のある髪飾り                                                           |
| **彩色・トーン** | 優しく、淡く、温かい色調。派手なネオンカラー等は避ける                                                     |

> 📝 **備考**
> この定義は、LoRA 生成、プロンプト設計、NSFW 制御の各実験において基盤となる人格・世界観の指針である。
> 各構図・出力検証において、この定義と照らし合わせた評価を推奨する。

### コンセプトイメージ（暫定）

| 前面                                                  | 背面                                                 | クローズアップ                                                            |
| ----------------------------------------------------- | ---------------------------------------------------- | ------------------------------------------------------------------------- |
| ![前面](concept_images/miyana_v20_01front_00160_.png) | ![背面](concept_images/miyana_v20_02back_00248_.png) | ![クローズアップ](concept_images/miyana_v20_11_portrait_right_00019_.png) |

## 2. ロードマップ

### v3.x 系 - 精緻化と構造分離

#### v3.1 - ベース雅凪 LoRA 作成

- **目的**：雅凪の「本質像」（人格、雰囲気、衣装、配色、質感、造形）を安定生成可能とする
- **アプローチ**：
  - 属性マップを活用した安定プロンプト設計
  - 左右非対称要素（髪流し、髪飾り等）を一旦除外し、左右対称構成を基本とする
  - 各構図別の安定データセットを整備
- **成果**：
  - 安定した「ベース雅凪」LoRA モデル
  - すべての派生モデルの土台となるプラットフォームを完成

#### v3.2 - パーツ個別 LoRA 化による非対称表現の拡張

- **目的**：左右非対称パーツ（髪飾り、サイドヘア等）を局所 LoRA で個別制御可能にする
- **アプローチ**：
  - パーツ単位のタグ設計・アノテーション整理
  - パーツ有無／左右位置が明確な素材の収集と抽出型選別
  - パーツ LoRA 学習（加算スロット型構造を前提とした補助学習）
- **成果**：
  - プロンプト＋ LoRA 組み合わせにより、任意の構図・向き・パーツ構成でも安定生成可能となる

---

### v4.x 系 - 汎用性拡張

- **目的**：スタイル間の汎用性を追求した LoRA へ進化
- **アプローチ**：
  - 多スタイル対応プロンプト設計
  - スタイル調整タグの実験と評価
  - 複数構図・複数表現の学習素材追加

---

### v5.x 系 - 汎用化と公開展開

- **目的**：誰もが自由に「雅凪」を使える環境を提供
- **アプローチ**：
  - モデルアーキテクチャの多様化（XL、Turbo、SD1.5 対応など）
  - モデル API 経由の活用（例：Web UI、Discord Bot、画像生成 API）

### 3. 本 Project のディレクトリ構造

- src: ソースコード。今のところは属性マップの markdown を保存
- prompts: 構図ごとのプロンプト。構図ごとにディレクトリを作成し、ポジティブ / ネガティブプロンプトをテキスト形式で保存
- learning_sources: LoRA 学習用に用いる素材の格納場所。構図ごとにディレクトリを作成し、そこに学習画像とタグファイルを設置

## 4. Markdown による属性マップの管理方法

### 属性マップの場所

- [ポジティブプロンプト](src/attribute_map/positive.md)
- [ネガティブプロンプト](src/attribute_map/negative.md)

### コンセプト

LoRA 構築・検証の効率化のため、プロンプトをカテゴリ別に構造化し、構図別に使用有無および重み付けの数値を設定する。

### 記述フォーマット

属性マップは Markdown Table でマトリクス形式で記述する。

#### 列

以下の順で定義されている。

- タグ日本語名説明
- タグの英名（実際にプロンプトで使われる名前）
- 以降は構図名（front, close up など）

> ⚠️ 構図名（例：`front`, `back`, `close-up` など）は現段階では仮称です。
> 今後の検証および素材整備により、正式な命名および仕様として確定予定です。

#### 行

各タグの情報を記述。
構図名の列に対しては、以下の値が設定される

- `o` = 使用
- `x` = 不使用
- `1.2` などの数値 = 重み付けをする場合の値

#### タグのカテゴリごとのグルーピング

メンテナンス性を高めるため、タグのカテゴリごとにテーブルを定義する。

カテゴリ名は ### タグで記載する

#### 記載例

```md
### 🧍‍♀️ ポーズ・構図

| 日本語名         | タグ名               | front | back | left-side | close-up |
| :--------------- | :------------------- | :---- | :--- | :-------- | :------- |
| 立っている       | standing             | o     | o    | o         | o        |
| 何も持っていない | not holding anything | 1.2   | 1.2  | 1.2       | x        |

### 💇‍♀️ 髪型・髪色

| 日本語名                   | タグ名                | front | back | left-side | close-up |
| :------------------------- | :-------------------- | :---- | :--- | :-------- | :------- |
| ミルキーミントグリーンの髪 | milky mint green hair | 1.3   | 1.3  | 1.3       | 1.3      |
| 淡いミントの色合い         | pale mint shade       | o     | o    | o         | o        |
```

### 活用目的

- プロンプト構築の高速化
- 属性の一貫性維持と構図ごとの差異可視化
- LoRA 学習素材のバリエーション管理と再生成支援

## 5. Markdown によるスタイルマップの管理方法

### スタイルマップの場所

- [ポジティブプロンプト](src/style_map/positive.md)
- [ネガティブプロンプト](src/style_map/negative.md)

### スタイルタグの位置付け

- スタイルタグはプロンプトの全生成物に共通適用される画風・塗り・線画・彩色の統制要素。
- 属性マップと完全に分離して管理される。
  - その理由: タグの集合を管理する軸が異なり、原則として因果関係が無いため。
    - 属性マップは「構図軸」
    - スタイルタグは「スタイル軸」
    - ※スタイル（画風・塗・線画・彩色）は構図に依存しないことをイメージしてもらえば分かりやすい

### スタイルタグ定義ファイルフォーマット

- スタイルタグ群は、属性マップ同様のフォーマットである
- 「###」によるカテゴリ名記載
- 列は「日本語名」「タグ名」「以降はスタイル名」
- タグ行の「スタイル」に対応するセルは、属性マップと共通（使用: `o`, 不使用: `x`, 重み付け: 数値指定）

### 記載例

```md
### 品質・品質制御

| 日本語名 | タグ名       | v3.1.2 |
| -------- | ------------ | ------ |
| 傑作     | masterpiece  | o      |
| 最高品質 | best quality | o      |

### 雰囲気・印象

| 日本語名         | タグ名       | v3.1.2 |
| ---------------- | ------------ | ------ |
| 洗練された雰囲気 | refined aura | 1.2    |
| 優雅             | graceful     | o      |
```

## 6. プロンプト出力ルール

属性マップ、スタイルマップから抽出された各種タグは以下の順番で出力する。

1. スタイルマップ
2. 属性マップ

### プロンプトのフォーマット

ヒューマンリーダブルを保つため、以下のルールとする

- 各タグは 1 行ごとに記述し、行末にはカンマを付ける
- Markdown 上でヘッダとして定義されている「カテゴリ名」は、タグ情報以外はプロンプトには含めない（ツールがタグと誤認するリスクを避けるため）
- 代わりに、カテゴリ単位で 1 行の空行を挿入し、視認性を確保する

### 例

#### GOOD

```
masterpiece,
best quality,

(refined aura:1.2),
graceful,

standing,
(not holding anything:1.2),

(milky mint green hair:1.3),
pale mint shade,
```

#### NG

```
# 🧍‍♀️ ポーズ・構図
standing,
(not holding anything:1.2),

# 💇‍♀️ 髪型・髪色
(milky mint green hair:1.3),
pale mint shade,

# 品質・品質制御
masterpiece,
best quality,

# 雰囲気・印象
(refined aura:1.2),
graceful,
```

NG な理由:

- 出力順が「属性マップ」->「スタイルマップ」の順になっている
- タグ以外の情報（Markdown 上でカテゴリとして表記されるラベル情報）が含まれている

## 7. 成果物の保存

各バージョンの作業完了時 [artifacts](./artifacts) 以下を保存しておく

- スタイル・属性マップの指定により出力されたプロンプト
- 実際に生成された画像数点
